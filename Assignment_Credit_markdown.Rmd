---
title: "Credit Data Set"
author: "Alessandro Lo Verde"
date: "30/04/2023"
output:
  html_document:
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
if (!require(rmarkdown)){
  install.packages("rmarkdown")
  library(rmarkdown)
}
```
## Libraries

The `library()` function is used to load *libraries*, or groups of  functions and data sets that are not included in the base `R` distribution. Basic functions that perform least squares linear regression and other simple analyses
come standard with the base distribution,  but more exotic functions require additional libraries.
 Here we load the `MASS` package, which is a very large collection of data sets and functions. We  also load the `ISLR2` package, which includes the data sets associated with this book (Tbishirani).

```{r chunk1}
library(MASS)
library(ISLR2)

if (!require(broom)){
install.packages("broom")
library(broom)
}
if (!require(rlang)){
install.packages("rlang")
library(rlang)
}
if (!require(dplyr)){
install.packages("dplyr")
library(dplyr)
}

if (!require(Hmisc)){
install.packages("Hmisc")
library("Hmisc")
}
#pvalue
if (!require(fastDummies)){
install.packages("fastDummies")
library(fastDummies)
}

if (!require(caTools)){
install.packages("caTools")    # For Linear regression 
library(caTools)
}
  if (!require(car)){
install.packages('car')
library(car)
  }

#Subset Selection

  if (!require(tidyverse)){
install.packages('tidyverse')
library(tidyverse)
  }

 if (!require(caret)){
install.packages('caret')
library(caret)
 }

 if (!require(leaps)){
install.packages('leaps')
library(leaps)
 }

```

-----------------------------------------------------------------

Let's define the working directory.

```{r}
rm(list = ls())
setwd("/Users/alessandroloverde/Library/Mobile Documents/com~apple~CloudDocs/Master Statistical Learning e Data Science/Z - Past Courses/Statistical Inference and Modeling/Assignment Credit/")
```

### 1. Carichiamo il dataset Credit.csv 

Il dataset Credit.csv del libro di Tbishirani contiene n = 4000 osservazioni di 11 variabili relative a n titolari di carta. 

La variabile risposta è il Balance (saldo del debito medio della carta di credito per ogni individuo).
Le variabili quantitative sono le seguenti: 

- Age, 
- Cards (numero di carte di credito),
- Education (anni di istruzione), 
- Income (in migliaia di dollari), 
- Limit (limite di credito concesso),
- Rating (rating di credito posseduto).

Le variabili qualitative sono: 

- Own (proprietà o meno di una casa: Yes/ No),
- Married (stato di coniugato o meno: Yes/ No),
- Student (stato di studente o meno: Yes/ No),
- Region (Regione degli USA: West, East, South)

```{r}
dataC = read.csv("Credit.csv", header = TRUE)
```

### 2. Scatterplots

Ogni pannello delle figure seguenti è uno scatterplot per una coppia di variabili quantitative del dataset.

Qui presentiamo i scatterplot più rilevanti:

- Quelli relativi a Balance, con le variabili che presentano la maggiore correlazione (lo vedremo in seguito) con essa (Income, Limit, Age, Cards);

- lo scatterplot che mostra la quasi perfetta correlazione tra rating e limit (in seguito decideremo di tenere solamente la variabile limit).

```{r}

'Balance'

plot(dataC$Balance,dataC$Income)
plot(dataC$Balance,dataC$Limit)
plot(dataC$Balance,dataC$Age)
plot(dataC$Balance,dataC$Cards)

'Limit'


plot(dataC$Limit,dataC$Rating)
```

### 3. Creazione delle variabili dummies per descrivere le variabili qualitative 

Supponiamo di voler studiare le differenze nel saldo del debito nella carta di credito tra chi possiede una casa e chi no, ignorando per il momento le altre variabili.

Se un predittore qualitativo ha solo due valori possibili, basta creare un indicatore o una variabile dummy che assume due possibili valori numerici.

Prendiamo per esempio i valori 0/1 per le variabili Student, Married, Own.

Nel caso particolare di Region, che contiene tre variabili (East, West, South), creiamo tre variabili che si accendono e si spengono quando il rapporto appartiene ad una regione o ad un'altra.

Sostituiamo infine le colonne con le dummies alle colonne con le variabili qualitative nel dataset.

```{r}
'Create Dummies variables (Own, Student, Married, Region) -> 0/1'

Dummies <- dummy_cols(dataC, select_columns = c("Own","Student","Married", "Region"))

dataDummies <-cbind ( dataC, Dummies$Own_Yes, Dummies$Student_Yes, Dummies$Married_Yes, Dummies$Region_East, Dummies$Region_South, Dummies$Region_West)

dataDummies$Own <- NULL
dataDummies$Student <- NULL
dataDummies$Married <- NULL
dataDummies$Region <- NULL

dataDummies <- dataDummies %>% 
  rename("Own_Yes" = "Dummies$Own_Yes",
         "Student_Yes" = "Dummies$Student_Yes", 
         "Married_Yes" = "Dummies$Married_Yes", 
         "Region_East" = "Dummies$Region_East", 
         "Region_South" = "Dummies$Region_South", 
         "Region_West" = "Dummies$Region_West")

```

### 4.1 Gestione delle variabili Dummies: Regressione lineare di Own (0/1) su Balance

Sulla base della nuova variabile Own (Own_i = 1 se la persona iesima possiede una casa, Own_i = 0 se la persona iesima non possiede una casa), possiamo utilizzare questa come predittore nel modello di regressione così definito:

Balance_i = β_0 + β_1*Own_i + εi

 ->  Balance_i (i-th person does not own a house) = β_0 + εi
 
 ->  Balance_i (i-th person owns a house) = β_0 + β_1+ εi
 
- β_0 può essere interpretato come il saldo medio del debito nella carta di credito tra coloro che non possiedono una casa, 
- β_0 + β_1 può essere interpretato come il saldo medio del debito nella carta di credito tra coloro che possiedono una casa 
- β_1 può essere interpretato come la differenza media del saldo medio del debito nella carta di credito tra proprietari e non proprietari.

Il debito medio con la carta di credito per i non proprietari è stimato in 509,80 dollari, mentre si stima che i proprietari abbiano un debito aggiuntivo di 19,73 dollari, per un totale di 509,80 dollari + 19,73 dollari = 529,53 dollari. Tuttavia, notiamo che il valore di p per la variabile dummy è molto alto. Ciò indica che non vi è forte evidenza statistica in questo modello di una differenza nel saldo medio della carta di credito dovuta all' avere la proprietà di un'abitazione.

La tabella che verrà printata alla fine mostra le stime dei coefficienti e altre informazioni associate al modello (deviazione standard nella stima dei coefficienti, t- statistic, p-value). 

Al momento stiamo valutando modi di inserire le nostre dummies, il modello è sicuramente non completo e non esaustivo, ad esempio vedendo semplicemente l'R^2 = 0,0004 ci accorgiamo di quanto abbia un valore molto basso.

```{r}
'Regression of Balance onto own in the Credit Data Set (Own hose 0/1)'

dataDummies.Balance.lm.Own <- lm(Balance ~ Own_Yes, data = dataDummies)

print("The R squared of the lm of Balance onto own in the Credit Data Set is:")
summary(dataDummies.Balance.lm.Own )$r.squared


β_0.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[1,1]
β_1.Balance.Own <- summary(dataDummies.Balance.lm.Own )$coefficients[2,1]
predicted.Balance.Own = β_0.Balance.Own + β_1.Balance.Own
sigma_0.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[1,2]
sigma_1.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[2,2]
t_0.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[1,3]
t_1.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[2,3]
pvalue_0.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[1,4]
pvalue_1.Balance.Own <- summary(dataDummies.Balance.lm.Own)$coefficients[2,4]

#create matrix

data.Balance.Own  <- matrix(formatC(c(β_0.Balance.Own, β_1.Balance.Own , predicted.Balance.Own, sigma_0.Balance.Own, sigma_1.Balance.Own, 0, t_0.Balance.Own, t_1.Balance.Own , 0, pvalue_0.Balance.Own, pvalue_1.Balance.Own , 0),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Own) <- c('β_0 ', 'β1','β0 + β1')
colnames(data.Balance.Own) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Own  <- as.table(data.Balance.Own )

#display table

data.Balance.Own

```
### 4.2 Gestione e interpretazione delle variabili Dummies: Regressione di Own (-1/1) on Balance

 In alternativa ad uno schema di codifica 0/1, potremmo creare una variabile dummy (Own_i = 1 se la persona i-esima possiede una casa, Own_i = -1 se la persona iesima non possiede una casa) e utilizzare questa variabile nell'equazione di regressione. 
 
 
Otteniamo dunque il modello:
 
 Balance_i = β_0 + β_1*Own_i + εi
 
 ->  Balance_i (i-th person owns a house) = β_0 + β_1 + εi
 ->  Balance_i (i-th person does not own a house) = β_0 - β_1 + εi
 
- β_0 può essere interpretato come il saldo medio complessivo del debito nella carta di credito (ignorando l'effetto della proprietà dell'abitazione);

- β_1 può essere interpretato dunque come la differenza in positivo (in negativo) tra il saldo medio del debito nella carta di credito dei proprietari (non proprietari) e il saldo medio complessivo del debito nella carta di credito (ignorando l'effetto della proprietà dell'abitazione). 

Dunque:

- β0 + β1 Saldo medio del debito nella carta di credito tra i proprietari di casa;

- β0 - β1 Saldo medio del debito nella carta di credito tra i non proprietari di casa;
In questo esempio, la stima per β_0 è di 519,665 dollari, a metà strada tra le medie di 509,80 e 529,53 dollari dei non proprietari e dei proprietari.

La stima per β_1 è di 9,865 dollari, la metà di 19,73 dollari, la differenza media tra proprietari e non proprietari. 

È importante notare che le predizioni finali, rispetto al modello precedente, per i saldi dei proprietari e dei non proprietari saranno identiche, indipendentemente dallo schema di codifica utilizzato.
La differenza tra questo approccio e il precedente sta nel modo in cui possono essere interpretati i coefficienti.

Anche in questo caso stiamo valutando modi di inserire le nostre dummies e l'intepretazione dei coefficienti, il modello è sicuramente non completo e non esaustivo (R^2 = 0,0004).

```{r}

'Create Dummies variables (Own) -1/1'

dataDummies2 <- dataDummies
dataDummies2$Own_Yes <- replace(dataDummies2$Own_Yes, dataDummies2$Own_Yes == 0, -1) 

'Regression of Balance onto own in the Credit Data Set (Own hose -1/1)'

dataDummies2.Balance.lm.Own <- lm(Balance ~ Own_Yes, data = dataDummies2)

print("The R squared of the lm of Balance onto own in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Own )$r.squared


β_0.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[1,1]
β_1.Balance.Own <- summary(dataDummies2.Balance.lm.Own )$coefficients[2,1]
predicted.Balance.Own = β_0.Balance.Own + β_1.Balance.Own
predicted.Balance.NotOwn = β_0.Balance.Own - β_1.Balance.Own
sigma_0.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[1,2]
sigma_1.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[2,2]
t_0.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[1,3]
t_1.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[2,3]
pvalue_0.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[1,4]
pvalue_1.Balance.Own <- summary(dataDummies2.Balance.lm.Own)$coefficients[2,4]
#create matrix

data.Balance.Own.2  <- matrix(formatC(c(β_0.Balance.Own, β_1.Balance.Own , predicted.Balance.Own, predicted.Balance.NotOwn, sigma_0.Balance.Own, sigma_1.Balance.Own, 0, 0, t_0.Balance.Own, t_1.Balance.Own , 0, 0, pvalue_0.Balance.Own, pvalue_1.Balance.Own , 0, 0),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Own.2) <- c('β_0 ', 'β1','β0 + β1', 'β0 - β1 ')
colnames(data.Balance.Own.2) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Own.2  <- as.table(data.Balance.Own.2)

#display table

data.Balance.Own.2

```
### 4.3 Predittori qualitativi con più di due categorie

Quando un predittore qualitativo ha più di due categorie, una singola variabile dummy non può rappresentare tutti i valori possibili. 

In questa situazione, abbiamo necessità di creare ulteriori variabili dummy.

Ad esempio, per la variabile Region (East, West, South) abbiamo creato due variabili dummy.

La prima è: 

-> Region_South_i = 1 The i-th person is from the South
-> Region_South_i = 0 The i-th person is not from the South

La seconda è:
-> Region_West_i = 1 The i-th person is from the West
-> Region_West_i = 0 The i-th person is not from the West

Quindi entrambe le variabili possono essere utilizzate nell'equazione di regressione, per ottenere il modello:

 Balance_i = β_0 + β_1*Region_South_i + β_2*Region_West_i + εi
 
->  Balance_i (i-th person is from the South) = β_0 + β_1 + εi
->  Balance_i (i-th person is from the West) = β_0 + β_2 + εi
->  Balance_i (i-th person is from the East) = β_0 + εi

- β_0 può essere interpretato come il saldo medio del debito nella carta di credito per gli individui dell'Est (perchè non del sud e non dell'ovest), 
- β_1 può essere interpretato come la differenza tra il saldo medio tra le persone del Sud e quelle dell'Est
- β_2 può essere interpretato come la differenza tra il saldo medio tra quelli dell'Ovest e quelli dell'Est. 

Ci sarà sempre una variabile dummy in meno rispetto al numero di categorie qualitative della variabile qualitative. 
La categoria a cui non associamo alcuna variabile dummy (Est in questo esempio) è nota come Baseline.

La categoria scelta come baseline è arbitraria e le previsioni finali per ciascun gruppo saranno le stesse indipendentemente da questa scelta. Tuttavia, i coefficienti e i loro valori p dipendono dalla scelta della codifica della variabile dummy.

Dalla tabella si evince che il saldo stimato per i rapporti ubicati nell'Est, è di 531,00 dollari. 

Si stima che gli abitanti dell'Ovest avranno un debito inferiore di 18,69 dollari rispetto a quelli dell'Est e che quelli del Sud avranno un debito inferiore di 12,50 dollari rispetto a quelli dell'Est. 
Tuttavia, i valori di p associati alle stime dei coefficienti per le due variabili dummy sono molto grandi, il che suggerisce che non c'è una forte statistica di una reale differenza nel saldo medio delle carte di credito tra Sud ed Est o tra Ovest ed Est. 

Oltre a basarci sulle singole stime dei coefficienti e i relativi valori p, possiamo utilizzare un test F per verificare congiuntamente H0: β1 = β2 = 0; e il risultato di questo test non dipende dalla codifica. 
Questo test F ha un valore p di 0,96, il che indica che non possiamo rifiutare l'ipotesi nulla -> nessuna relazione tra Balance e Region.

```{r}

#define function to extract overall p-value of model
overall_p <- function(my_model) {
    f <- summary(my_model)$fstatistic
    p <- pf(f[1],f[2],f[3],lower.tail=F)
    attributes(p) <- NULL
    return(p)
}

'Qualitative Predictors with More than Two Levels (Region South, West or East)'

dataDummies2.Balance.lm.Region_South.Region_West <- lm(Balance ~ Region_South + Region_West, data = dataDummies2)

print("The R squared of the lm of Balance onto own in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Region_South.Region_West)$r.squared

f <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Region_South.Region_West)

β_0.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[1,1]
β_1.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[2,1]
β_2.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[3,1]

predicted.Balance.Region_South = β_0.Balance.Region_South.Region_West + β_1.Balance.Region_South.Region_West
predicted.Balance.Region_West = β_0.Balance.Region_South.Region_West + β_2.Balance.Region_South.Region_West

sigma_0.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[1,2]
sigma_1.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[2,2]
sigma_2.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[3,2]

t_0.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[1,3]
t_1.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[2,3]
t_2.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[3,3]

pvalue_0.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[1,4]
pvalue_1.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[2,4]
pvalue_2.Balance.Region_South.Region_West <- summary(dataDummies2.Balance.lm.Region_South.Region_West)$coefficients[3,4]

#create matrix

data.Balance.Region_South.Region_West <- matrix(formatC(c(β_0.Balance.Region_South.Region_West, β_1.Balance.Region_South.Region_West , β_2.Balance.Region_South.Region_West, predicted.Balance.Region_South, predicted.Balance.Region_West, 0, sigma_0.Balance.Region_South.Region_West, sigma_1.Balance.Region_South.Region_West, sigma_2.Balance.Region_South.Region_West, 0, 0, 0, t_0.Balance.Region_South.Region_West, t_1.Balance.Region_South.Region_West, t_2.Balance.Region_South.Region_West, 0, 0,f[1], pvalue_0.Balance.Region_South.Region_West, pvalue_1.Balance.Region_South.Region_West, pvalue_2.Balance.Region_South.Region_West, 0, 0, p.Value.f),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Region_South.Region_West) <- c('β_0 (East)', 'β_1 (South versus the East)','β_2 (West versus East)','β0 + β1 (South)', 'β0 + β2 (West)', 'F-Test (H0 : β1 = β2 = 0)')

colnames(data.Balance.Region_South.Region_West) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Region_South.Region_West  <- as.table(data.Balance.Region_South.Region_West)

#display table

data.Balance.Region_South.Region_West

```
### 4.4 Predittori qualitativi e predittori quantitativi

E' possibile implementare modelli di regressione a variabili multiple, che incorporino predittori quantitativi e qualitativi congiuntamente. 

Per esempio, possiamo far regredire Balance su una variabile quantitativa come Income e su una variabile qualitativa come Student.

Per fare ciò, dobbiamo semplicemente creare una variabile dummy per lo status di studente e poi applicare un modello di regressione multipla usando il reddito (Income) e la variabile dummy Student_Yes come predittori del saldo della carta di credito (Balance).

La dummy per lo status di studente Student_Yes è:
-> Student_Yes_i = 1 The i-th person is a student
-> Student_Yes_i = 0 The i-th person is a student

Quindi, inserendo entrambe le variabili nell'equazione di regressione, otteniamo il modello:

 Balance_i = β_0 + β_1 * Income_i + β_2 * Student_Yes_i _i + εi
 
->  Balance_i (i-th person is a Student) = β_0 + β_1 * Income_i + β_2 + εi
->  Balance_i (i-th person is not a Student) = β_0 + β_1 * Income_i + εi

Possiamo dare in questo caso un'interpretazione di questo tipo ai coefficienti:

- β_0:  saldo medio del debito nella carta di credito tra gli individui che non sono studenti e hanno teoricamente 0 Income;

- β_1 : differenza osservata nel saldo medio del debito per ogni unità addizionale di Income;

- β_2 : differenza osservata nel saldo medio del debito tra studenti e non studenti;

- β0 + β2:  saldo medio del debito nella carta di credito tra gli individui che sono studenti e hanno teoricamente 0 Income;

I coefficienti sono tutti statisticamente significativi e il test F per verificare congiuntamente H0 : β1 = β2 = 0 ha un valore p prossimo allo zero, il che indica che possiamo respingere con una confidenza l'ipotesi nulla che non vi sia congiuntamente alcuna relazione tra Balance ed  Income , status di Studente.

L'$R^2$ = 0.28 non è ancora soddisfacente, quindi probabilmente dobbiamo inserire altri regressori nel nostro modello.

```{r}

'Qualitative Predictors with quantitative predictors (Income and Student)'

dataDummies2.Balance.lm.Income.Student_Yes <- lm(Balance ~ Income + Student_Yes, data = dataDummies2)

print("The R squared of the lm of Balance onto Income and Student (0/1) in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Income.Student_Yes)$r.squared

f <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Income.Student_Yes)

β_0.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[1,1]
β_1.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[2,1]
β_2.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[3,1]

predicted.Income.Student_No_zeroincome = β_0.Balance.Income.Student_Yes 
predicted.Income.Student_Yes_zeroincome  = β_0.Balance.Income.Student_Yes + β_2.Balance.Income.Student_Yes

sigma_0.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[1,2]
sigma_1.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[2,2]
sigma_2.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[3,2]

t_0.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[1,3]
t_1.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[2,3]
t_2.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[3,3]

pvalue_0.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[1,4]
pvalue_1.Balance.Income.Student_Yes<- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[2,4]
pvalue_2.Balance.Income.Student_Yes <- summary(dataDummies2.Balance.lm.Income.Student_Yes)$coefficients[3,4]

#create matrix

data.Balance.Income.Student_Yes <- matrix(formatC(c(β_0.Balance.Income.Student_Yes, β_1.Balance.Income.Student_Yes , β_2.Balance.Income.Student_Yes, predicted.Income.Student_Yes_zeroincome, 0, sigma_0.Balance.Income.Student_Yes, sigma_1.Balance.Income.Student_Yes, sigma_2.Balance.Income.Student_Yes, 0, 0, t_0.Balance.Income.Student_Yes, t_1.Balance.Income.Student_Yes, t_2.Balance.Income.Student_Yes, 0,f[1], pvalue_0.Balance.Income.Student_Yes, pvalue_1.Balance.Income.Student_Yes, pvalue_2.Balance.Income.Student_Yes, 0, p.Value.f),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Income.Student_Yes) <- c('β_0', 'β_1','β_2', 'β0 + β2', 'F-Test (H0 : β1 = β2 = 0)')

colnames(data.Balance.Income.Student_Yes) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Income.Student_Yes  <- as.table(data.Balance.Income.Student_Yes)

#display table

data.Balance.Income.Student_Yes

```
### 5. Rimozione dell'ipotesi di additività e di linearità

Il modello di regressione lineare standard fornisce risultati interpretabili e funziona abbastanza bene in molti problemi del mondo reale. Tuttavia, formula diverse ipotesi molto restrittive che vengono spesso violate nella pratica. 
Due delle ipotesi più importanti affermano che la relazione tra i predittori e la variabile risposta è additiva e lineare. 

- L'ipotesi di additività significa che l'associazione tra un predittore X_j e la risposta Y non dipende dai valori degli altri predittori. 

- L'ipotesi di linearità afferma che la variazione della risposta Y associata a una variazione di un'unità di X_j è costante, indipendentemente dal valore di X_j. 

Qui  di seguito esaminiamo brevemente alcuni approcci classici comuni per estendere il modello lineare.

### 5.1 Inclusione di interaction Terms (Rimozione della impotesi di additività)

Il concetto di interazione si applica anche alle variabili qualitative o a una combinazione di variabili quantitative e qualitative. 
Un'interazione tra una variabile qualitativa e una quantitativa ha un'interpretazione particolarmente semplice.

Supponiamo come nell'esempio precedente di voler prevedere Balance utilizzando le variabili Income (quantitativa) e studente (qualitativa). 

In assenza di un termine di interazione, il modello assume la stessa forma descritta precedentemente:

 Balance_i = β_0 + β_1 * Income_i + β_2 * Student_Yes_i _i + εi

Che possiamo vedere come due modelli di regressioni differenti:

->  Balance_i (i-th person is a Student) = β_0 + β_1 * Income_i + β_2 + εi
->  Balance_i (i-th person is not a Student) = β_0 + β_1 * Income_i + εi

Si noti che tali modelli si sostanziano in due rette parallele, una per gli studenti e una per i non studenti. 
Le rette per gli studenti e per i non studenti hanno intercette diverse, β0 + β2 contro β0, ma la stessa pendenza, β1. 

Il fatto che le linee siano parallele significa che l'effetto medio sul saldo del debito nella carta di un aumento di un'unità di Income non dipende dal fatto che l'individuo sia o meno uno studente. 

Questo rappresenta un limite potenzialmente per il modello, poiché in effetti una variazione del reddito può avere un effetto molto diverso sul saldo della carta di credito di uno studente rispetto a un non studente.

Questa limitazione può essere superata aggiungendo una variabile di interazione (Income_i * Student_Yes_i), creata moltiplicando Income con la variabile dummy status di studente. 
Il nostro modello diventa ora:

Balance_i = β_0 + β_1 * Income_i + β_2 * Student_Yes_i _i + β_3 * Income_i * Student_Yes_i +  εi
 
->  Balance_i (i-th person is a Student) = β_0 + β_2 + (β_1 + β_3)  * Income_i + εi
->  Balance_i (i-th person is not a Student) = β_0 + (β_1 + β_3) * Income_i + εi

- β_0:  saldo medio del debito nella carta di credito tra gli individui che non sono studenti e hanno teoricamente 0 Income;

- β_1 : differenza osservata nel saldo medio del debito per ogni unità addizionale di Income per i non studenti;

- β_2 : differenza osservata nel saldo medio del debito tra studenti e non studenti che hanno 0 income;

- β0 + β2: saldo medio del debito nella carta di credito tra gli individui che sono studenti e hanno teoricamente 0 Income;

- β_1 + β_3: differenza osservata nel saldo medio del debito per ogni unità addizionale di Income per i studenti;

Ancora una volta, abbiamo due diverse rette di regressione per gli studenti e per i non studenti. 
Queste rette di regressione hanno come prima intercette diverse, β0 + β2 (Studenti) e β0 (Non studenti), ma anche pendenze diverse, β1+β3 (Studenti) e β1 (Non studenti). 

Notiamo che la pendenza per gli studenti è inferiore a quella dei non studenti. Ciò suggerisce che un aumento del reddito è associato a un minore aumento del saldo del debito nella carta di credito tra gli studenti rispetto ai non studenti.

Tale modello ci consente di verificare l'ipotesi che le variazioni di reddito possano influire in modo diverso sui saldi delle carte di credito di studenti e non studenti.
Il coefficiente β_3 non è però molto significativo (pvalue = 0.25; vedi tabella sotto).
Facendo alcune prove neanche una interaction variable tra Limit e Student_Yes risulta essere significativa.
Pertanto, anche se un'analisi più approfondita sulle varie possibilità può essere portata avanti, nell'analisi che segue, non continueremo a ricercare variabili di interazione da inserire nel modello.

```{r}

'Plot of the predicted values for the model without interaction terms'

predicted.Income.Student_No_zeroincome = β_0.Balance.Income.Student_Yes 
predicted.Income.Student_Yes_zeroincome  = β_0.Balance.Income.Student_Yes + β_2.Balance.Income.Student_Yes

predicted.Income.Student_No = predicted.Income.Student_No_zeroincome + β_1.Balance.Income.Student_Yes * dataDummies2$Income
predicted.Income.Student_Yes =  predicted.Income.Student_Yes_zeroincome + β_1.Balance.Income.Student_Yes * dataDummies2$Income

plot(dataDummies2$Income, predicted.Income.Student_No, main="Regression of Balance onto Income and Student(0/1) in the Credit Data Set", xlab="Income", ylab="Balance", pch=20, col="red")

lines(dataDummies2$Income, predicted.Income.Student_Yes, main="Regression of Balance onto Income and Student(0/1) in the Credit Data Set", xlab="Income", ylab="Balance", pch=20, col="blue")

'Inclusion of interaction Terms (Remove of the additive assumption)'

'Plot of the predicted values for the model'

dataDummies2.Balance.lm.Income.Student_Yes_X <- lm(Balance ~ Income + Student_Yes + Income * Student_Yes, data = dataDummies2)

β_0.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[1,1]
β_1.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[2,1]
β_2.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[3,1]
β_3.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[4,1]

predicted.Income.Student_No_X_zeroincome = β_0.Balance.Income.Student_Yes_X 
predicted.Income.Student_Yes_X_zeroincome  = β_0.Balance.Income.Student_Yes_X + β_2.Balance.Income.Student_Yes_X

predicted.Income.Student_No_X = predicted.Income.Student_No_X_zeroincome + β_1.Balance.Income.Student_Yes_X * dataDummies2$Income
predicted.Income.Student_Yes_X =  predicted.Income.Student_Yes_X_zeroincome + (β_1.Balance.Income.Student_Yes_X + β_3.Balance.Income.Student_Yes_X) * dataDummies2$Income

plot(dataDummies2$Income, predicted.Income.Student_No_X, main="Regression of Balance onto Income, Student(0/1) and Income * Student_Yes", xlab="Income", ylab="Balance", pch=20, col="red")

lines(dataDummies2$Income, predicted.Income.Student_Yes_X, main="Regression of Balance onto Income, Student(0/1) and Income * Student_Yes", xlab="Income", ylab="Balance", pch=20, col="blue")

print("The R squared of the lm of Balance onto Income, Student (0/1) and Income * Student in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$r.squared

f <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Income.Student_Yes_X)

sigma_0.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[1,2]
sigma_1.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[2,2]
sigma_2.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[3,2]
sigma_3.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[4,2]

t_0.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[1,3]
t_1.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[2,3]
t_2.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[3,3]
t_3.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[4,3]

pvalue_0.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[1,4]
pvalue_1.Balance.Income.Student_Yes_X<- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[2,4]
pvalue_2.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[3,4]
pvalue_3.Balance.Income.Student_Yes_X <- summary(dataDummies2.Balance.lm.Income.Student_Yes_X)$coefficients[4,4]

#create matrix

data.Balance.Income.Student_Yes_X <- matrix(formatC(c(β_0.Balance.Income.Student_Yes_X, β_1.Balance.Income.Student_Yes_X , β_2.Balance.Income.Student_Yes_X, β_3.Balance.Income.Student_Yes_X, predicted.Income.Student_Yes_X_zeroincome, β_1.Balance.Income.Student_Yes_X + β_3.Balance.Income.Student_Yes_X, 0, sigma_0.Balance.Income.Student_Yes_X, sigma_1.Balance.Income.Student_Yes_X, sigma_2.Balance.Income.Student_Yes_X, sigma_3.Balance.Income.Student_Yes_X,  0, 0, 0, t_0.Balance.Income.Student_Yes_X, t_1.Balance.Income.Student_Yes_X, t_2.Balance.Income.Student_Yes_X, t_3.Balance.Income.Student_Yes_X, 0, 0,f[1], pvalue_0.Balance.Income.Student_Yes_X, pvalue_1.Balance.Income.Student_Yes_X, pvalue_2.Balance.Income.Student_Yes_X,pvalue_3.Balance.Income.Student_Yes_X, 0, 0, p.Value.f),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Income.Student_Yes_X) <- c('β_0', 'β_1','β_2', 'β_3', 'β0 + β2','β1 + β3', 'F-Test (H0 : β1 = β2 = β3 = 0)')

colnames(data.Balance.Income.Student_Yes_X) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Income.Student_Yes_X  <- as.table(data.Balance.Income.Student_Yes_X)

#display table

data.Balance.Income.Student_Yes_X

```

### 5.2 Inclusione di termini di grado >1 (Rimozione della impotesi di linearità)

Come discusso in precedenza, il modello di regressione lineare presuppone una relazione lineare tra la risposta e i predittori. In alcuni casi, però, la relazione reale tra la risposta e i predittori può essere non lineare. Qui presentiamo un modo molto semplice per estendere direttamente il modello lineare per adattarlo a relazioni non lineari, utilizzando la regressione polinomiale.

Analizzando euristicamente i scatterplot si potrebbe ipotizzare una relazione non lineare tra Balance e income, proviamo dunque a fittare un modello di questo tipo:

Balance_i = β_0 + β_1 * Income_i + β_2 * Income_i^2 +  εi

L'uso della funzione poly() consente di evitare il problema della collinearità di variabili di gradi superiori tra loro, producendo polinomi ortogonali tra loro.

Analizzando i p-value del modello in cui inseriamo Income^2 come predittore, notiamo che tale β_2 non è significativo e quindi non è una modifica che porteremo avanti nella discussione.

L'unica altra relazione significativa e che potrebbe sembrare non lineare è quella tra Balance e limit, proviamo dunque a fittare un modello molto semplice di questo tipo:

Balance_i = β_0 + β_1 * Limit_i + β_2 * Limit_i^2 +  εi

Analizzando i p-value del modello in cui inseriamo Limit^2 come predittore, notiamo che tale  β_2 è significativo, e l'R^2 associato a questo modello anche se molto semplice è già molto alto (R^2 = 0,76).

Facendo alcune prove con gradi superiori al secondo, fino al grado 4, i coefficienti potrebbero risultare significativi. Il coefficiente associato al grado 3 non sembra essere molto significatvo.
Per semplicità teniamo come candidati i gradi di Limit fino al 4; questi sono predittori che potremmo considerare più avanti nella discussione. 

```{r}

'Inclusion of terms of higher degree (Remove of the linearity assumption)'

'Income^2'

dataDummies2.Balance.lm.Income.Income2 <- lm(Balance ~ poly(Income,2), data = dataDummies2)

β_0.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[1,1]
β_1.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[2,1]
β_2.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[3,1]

print("The R squared of the lm of Balance onto Income and Income^2 in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Income.Income2)$r.squared

f <- summary(dataDummies2.Balance.lm.Income.Income2)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Income.Income2)

sigma_0.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[1,2]
sigma_1.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[2,2]
sigma_2.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[3,2]

t_0.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[1,3]
t_1.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[2,3]
t_2.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[3,3]

pvalue_0.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[1,4]
pvalue_1.Balance.Income.Income2<- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[2,4]
pvalue_2.Balance.Income.Income2 <- summary(dataDummies2.Balance.lm.Income.Income2)$coefficients[3,4]

#create matrix

data.Balance.Income.Income2 <- matrix(formatC(c(β_0.Balance.Income.Income2, β_1.Balance.Income.Income2 , β_2.Balance.Income.Income2, 0, sigma_0.Balance.Income.Income2, sigma_1.Balance.Income.Income2, sigma_2.Balance.Income.Income2, 0, t_0.Balance.Income.Income2, t_1.Balance.Income.Income2, t_2.Balance.Income.Income2,f[1], pvalue_0.Balance.Income.Income2, pvalue_1.Balance.Income.Income2, pvalue_2.Balance.Income.Income2, p.Value.f), digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Income.Income2) <- c('β_0', 'β_1(grado 1)','β_2 (grado 2)', 'F-Test (H0 : β1 = β2 = 0)')

colnames(data.Balance.Income.Income2) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Income.Income2  <- as.table(data.Balance.Income.Income2)

#display table

data.Balance.Income.Income2

#'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'Limit^2'
dataDummies2.Balance.lm.Income.Limit2 <- lm(Balance ~ poly(Limit,2), data = dataDummies2)


β_0.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[1,1]
β_1.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[2,1]
β_2.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[3,1]

print("The R squared of the lm of Balance onto Limit and Limit^2 in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Income.Limit2)$r.squared

f <- summary(dataDummies2.Balance.lm.Income.Limit2)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Income.Limit2)

sigma_0.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[1,2]
sigma_1.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[2,2]
sigma_2.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[3,2]

t_0.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[1,3]
t_1.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[2,3]
t_2.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[3,3]

pvalue_0.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[1,4]
pvalue_1.Balance.Income.Limit2<- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[2,4]
pvalue_2.Balance.Income.Limit2 <- summary(dataDummies2.Balance.lm.Income.Limit2)$coefficients[3,4]

#create matrix

data.Balance.Income.Limit2 <- matrix(formatC(c(β_0.Balance.Income.Limit2, β_1.Balance.Income.Limit2 , β_2.Balance.Income.Limit2, 0, sigma_0.Balance.Income.Limit2, sigma_1.Balance.Income.Limit2, sigma_2.Balance.Income.Limit2, 0, t_0.Balance.Income.Limit2, t_1.Balance.Income.Limit2, t_2.Balance.Income.Limit2,f[1], pvalue_0.Balance.Income.Limit2, pvalue_1.Balance.Income.Limit2, pvalue_2.Balance.Income.Limit2, p.Value.f), digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Income.Limit2) <- c('β_0','β_1 (grado 1)','β_2 (grado 2)', 'F-Test (H0 : β1 = β2 = 0)')

colnames(data.Balance.Income.Limit2) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Income.Limit2  <- as.table(data.Balance.Income.Limit2)

#display table

data.Balance.Income.Limit2


#'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'Limit^4'
dataDummies2.Balance.lm.Income.Limit4 <- lm(Balance ~ poly(Limit, 4), data = dataDummies2)
summary(dataDummies2.Balance.lm.Income.Limit4)
β_0.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[1,1]
β_1.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[2,1]
β_2.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[3,1]
β_3.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[4,1]
β_4.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[5,1]

print("The R squared of the lm of Balance onto Limit,  Limit^2 and Limit^4 in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Income.Limit4)$r.squared

f <- summary(dataDummies2.Balance.lm.Income.Limit4)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Income.Limit4)

sigma_0.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[1,2]
sigma_1.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[2,2]
sigma_2.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[3,2]
sigma_3.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[4,2]
sigma_4.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[5,2]

t_0.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[1,3]
t_1.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[2,3]
t_2.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[3,3]
t_3.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[4,3]
t_4.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[5,3]

pvalue_0.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[1,4]
pvalue_1.Balance.Income.Limit4<- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[2,4]
pvalue_2.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[3,4]
pvalue_3.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[4,4]
pvalue_4.Balance.Income.Limit4 <- summary(dataDummies2.Balance.lm.Income.Limit4)$coefficients[5,4]
#create matrix

data.Balance.Income.Limit4 <- matrix(formatC(c(β_0.Balance.Income.Limit4, β_1.Balance.Income.Limit4 , β_2.Balance.Income.Limit4, β_3.Balance.Income.Limit4 , β_4.Balance.Income.Limit4, 0, sigma_0.Balance.Income.Limit4, sigma_1.Balance.Income.Limit4, sigma_2.Balance.Income.Limit4, sigma_2.Balance.Income.Limit4, sigma_3.Balance.Income.Limit4, 0, t_0.Balance.Income.Limit4, t_1.Balance.Income.Limit4, t_2.Balance.Income.Limit4,t_3.Balance.Income.Limit4, t_4.Balance.Income.Limit4,f[1], pvalue_0.Balance.Income.Limit4, pvalue_1.Balance.Income.Limit4, pvalue_2.Balance.Income.Limit4,  pvalue_3.Balance.Income.Limit4, pvalue_4.Balance.Income.Limit4, p.Value.f), digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Income.Limit4) <- c('β_0', 'β_1','β_2','β_3','β_4', 'F-Test (H0 : β1 = β2  = β3 = β4 = 0)')

colnames(data.Balance.Income.Limit4) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Income.Limit4  <- as.table(data.Balance.Income.Limit4)

#display table

data.Balance.Income.Limit4
```

6 Selezione euristica del modello

6.1 Analisi delle correlazioni e potenziali criticità: Collinearità tra le variabili X_i

Proviamo ad analizzare la tabella delle correlazioni tra le variabili nel dataset:
- Notiamo che in ordine le variabili: Limit, Rating, Income, Student, Cards, risultano avere correlazioni maggiori in modulo con la variabile risposta Balance. 
- Limit e Rating presentano un certo grado di correlazione, ma il VIF value (indice per valutare collinearità) risulta inferiore a 5 e quindi le selezioneremo entrambe per il nostro modello.
- Limit e Rating sono perfettamente correlati (probabilmente il rating associato al rapporto influenza il Limite applicato allo scoperto concesso); in questo caso inserire queste due variabili in un test VIF ne fa esplodere il valore. Le variabili sono collineari.
Al fine di evitare problemi di collinearità, ne prenderemo solo una per inserirla nel modello (scegliamo arbitrariamente Limit).

```{r}

res2 <- rcorr(as.matrix(dataDummies2))
res2

model <- lm(Balance  ~ Income + Limit + Cards + Age + Education , data=dataDummies2)
  
#create vector of VIF values
vif_values <- vif(model)

vif_values

#create horizontal bar chart to display each VIF value
barplot(vif_values, main = "VIF Values", horiz = TRUE, col = "steelblue")

#add vertical line at 5
abline(v = 5, lwd = 3, lty = 2)

model.rating <- lm(Balance  ~ Income + Limit + Rating + Cards + Age + Education , data=dataDummies2)

  
#create vector of VIF values(including rating)
vif_values <- vif(model.rating)

vif_values

#create horizontal bar chart to display each VIF value
barplot(vif_values, main = "VIF Values (Rating)", horiz = TRUE, col = "steelblue")

#add vertical line at 5
abline(v = 5, lwd = 3, lty = 2)
```

6.2 Modello selezionato in base alle correlazioni più alte

Dalla precedente analisi selezioniamo le variabili che sembrano più rilevanti per la nostra analisi: Income, Limit (Valutazione), Student, Cards.

Questo è il modello risultante:

Balance_i = β_0 + β_1 * Limit_i + β_2 * Income + β_3 * Student_Yes + β_3 * Cards +  εi

Analizzando il plot dei residui:

- possiamo notare un pattern nei residui lineare, per valore bassi di Balance, tendiamo a sovrastimare il valore di Balance e per valori più alti, tendiamo a sottostimarlo.

- Dal grafico QQ si vede chiaramente che i residui non sembrano approssimati perfettamente da una distribuzione normale, presentando la distribuzione empirica delle code più spesse.

In generale il modello sembra essere soddisfacente: 

- l'R^2 del modello è molto alto, 
- la distribuzione empirica dei residui del modello sembra ben centrata intorno allo 0;
- tutti i coefficienti delle variabili sembrano essere significativi statisticamente (Cards sembra avere il coefficiente meno significativo ed è la variabile esplicativa che probabilmente apporta meno al modello).

```{r}

dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards <- lm(Balance ~ Limit + Income + Student_Yes + Cards, data = dataDummies2)

β_0.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[1,1]
β_1.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[2,1]
β_2.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[3,1]
β_3.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[4,1]
β_4.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[5,1]

print("The R squared of the lm of Balance onto Limit, Income, Student (0/1) and Cards in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$r.squared

f <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)

sigma_0.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[1,2]
sigma_1.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[2,2]
sigma_2.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[3,2]
sigma_3.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[4,2]
sigma_4.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[5,2]

t_0.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[1,3]
t_1.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[2,3]
t_2.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[3,3]
t_3.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[4,3]
t_4.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[5,3]

pvalue_0.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[1,4]
pvalue_1.Balance.Limit.Income.Student_Yes.Cards<- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[2,4]
pvalue_2.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[3,4]
pvalue_3.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[4,4]
pvalue_4.Balance.Limit.Income.Student_Yes.Cards <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)$coefficients[5,4]

#create matrix

data.Balance.Limit.Income.Student_Yes.Cards <- matrix(formatC(c(β_0.Balance.Limit.Income.Student_Yes.Cards, β_1.Balance.Limit.Income.Student_Yes.Cards , β_2.Balance.Limit.Income.Student_Yes.Cards, β_3.Balance.Limit.Income.Student_Yes.Cards, β_4.Balance.Limit.Income.Student_Yes.Cards ,0, sigma_0.Balance.Limit.Income.Student_Yes.Cards, sigma_1.Balance.Limit.Income.Student_Yes.Cards, sigma_2.Balance.Limit.Income.Student_Yes.Cards, sigma_3.Balance.Limit.Income.Student_Yes.Cards,  sigma_4.Balance.Limit.Income.Student_Yes.Cards, 0, t_0.Balance.Limit.Income.Student_Yes.Cards, t_1.Balance.Limit.Income.Student_Yes.Cards, t_2.Balance.Limit.Income.Student_Yes.Cards, t_3.Balance.Limit.Income.Student_Yes.Cards, t_4.Balance.Limit.Income.Student_Yes.Cards,f[1], pvalue_0.Balance.Limit.Income.Student_Yes.Cards, pvalue_1.Balance.Limit.Income.Student_Yes.Cards, pvalue_2.Balance.Limit.Income.Student_Yes.Cards,pvalue_3.Balance.Limit.Income.Student_Yes.Cards, pvalue_4.Balance.Limit.Income.Student_Yes.Cards, p.Value.f),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Limit.Income.Student_Yes.Cards) <- c('β_0', 'β_1 (Limit)','β_2(Income)', 'β_3(Student)','β_4(Cards)', 'F-Test (H0 : β1 = β2 = β3 = β4 = 0)')

colnames(data.Balance.Limit.Income.Student_Yes.Cards) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Limit.Income.Student_Yes.Cards  <- as.table(data.Balance.Limit.Income.Student_Yes.Cards)

#display table

data.Balance.Limit.Income.Student_Yes.Cards

res <- resid(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)
#produce residual vs. fitted plot
plot(fitted(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards), res)

print("The Root Mean Squared Error/AIC/BIC of the lm of Balance onto Limit, Income, Student (0/1) and Cards in the Credit Data Set is:")
RMSE <- sqrt(mean(res^2))
RMSE
Criterions <- glance(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards)
Criterions

#add a horizontal line at 0 
abline(0,0)

#create Q-Q plot for residuals
qqnorm(res)

#add a straight diagonal line to the plot
qqline(res) 

#Create density plot of residuals
plot(density(res))

```

6.3 Modello selezionato euristicamente con variabili di grado > 1 

Tenuto conto dell'analisi contenute nel paragrafo precedente e nel 5.2, proviamo ad inserire nel nostro modello dei termini di Limit di grado superiore al primo (che euristicamente avevamo notato avere una relazione non lineare con Balance negli Scatterplot).

Il nostro modello candidato scelto in base alle correlazioni e all'analisi del paragrafo 5.2 di grado superiore al primo è il seguente:

Balance_i = β_0 +  β_1 * Income + β_2 * Student_Yes + β_2 * Cards + β_3 * Limit_i + β_4 * Limit_i^2 + β_5 * Limit_i^3 + β_6 * Limit_i^4  εi

In generale il modello sembra essere buono: 

- Notiamo nel grafico dei residui calcolati (nello stesso training set però), come ora questi siano molto diminuiti in media (RMSE più basso).

- l'R^2 del modello è ancora più alto (stiamo aumentando i nostri regressori però), 

- la distribuzione dei residui del modello sembra migliorata e ben centrata intorno allo 0 e tutti i coefficienti delle variabili sembrano essere significative statisticamente.

- AIC e BIC del nostro nuovo modello sono entrambi inferiori a quelli del modello precedente. Ciò suggerisce che i vantaggi di un maggiore potere esplicativo superano il costo dell'aumento della complessità del modello, secondo entrambi i criteri informativi.

Come lato negativo di questa scelta di modello c'è che stiamo aumentando di 3 variabili il modello (meno parsimonioso) senza avere una grandissima differenza nei risultati (a parte quelli citati) e otteniamo anche alcuni singoli errori (pochi) più alti in valore assoluto rispetto a prima.
In più stiamo valutando la bontà di questi modelli con delle stime indirette del test error; una possibile estensione di questo lavoro potrebbe essere valutare questi modelli dividendo tra training set e test set e calcolando quin l'RMSE_Test con una stima diretta per valutare il modello ottimale.


Nel prossimo paragrafo ci limitiamo ad utilizzare queste stime indirette del test error (criteri AIC, BIC, CP...) per selezionare un modello ottimale e vedere quanto queste variano superata una certa soglia di 4 variabili.


```{r}

dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2  <- lm(Balance ~ Income  + Student_Yes +  Cards + poly(Limit,4), data = dataDummies2)

β_0.Balance.Limit.Income.Student_Yes.Cards.Limit2<- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[1,1]
β_1.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[2,1]
β_2.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[3,1]
β_3.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[4,1]
β_4.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[5,1]
β_5.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[6,1]
β_6.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[7,1]

print("The R squared of the lm of Balance onto Income, Student (0/1), Cards and poly(Limit , 4) in the Credit Data Set is:")
summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$r.squared

f <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$fstatistic
p.Value.f <- overall_p(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)

sigma_0.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[1,2]
sigma_1.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[2,2]
sigma_2.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[3,2]
sigma_3.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[4,2]
sigma_4.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[5,2]
sigma_5.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[6,2]
sigma_6.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[7,2]

t_0.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[1,3]
t_1.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[2,3]
t_2.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[3,3]
t_3.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[4,3]
t_4.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[5,3]
t_5.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[6,3]
t_6.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[7,3]

pvalue_0.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[1,4]
pvalue_1.Balance.Limit.Income.Student_Yes.Cards.Limit2<- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[2,4]
pvalue_2.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[3,4]
pvalue_3.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[4,4]
pvalue_4.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[5,4]
pvalue_5.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[6,4]
pvalue_6.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- summary(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)$coefficients[7,4]

#create matrix

data.Balance.Limit.Income.Student_Yes.Cards.Limit2 <- matrix(formatC(c(β_0.Balance.Limit.Income.Student_Yes.Cards.Limit2, β_1.Balance.Limit.Income.Student_Yes.Cards.Limit2 , β_2.Balance.Limit.Income.Student_Yes.Cards.Limit2, β_3.Balance.Limit.Income.Student_Yes.Cards.Limit2, β_4.Balance.Limit.Income.Student_Yes.Cards.Limit2 ,β_5.Balance.Limit.Income.Student_Yes.Cards.Limit2 , β_6.Balance.Limit.Income.Student_Yes.Cards.Limit2 , 0, sigma_0.Balance.Limit.Income.Student_Yes.Cards.Limit2, sigma_1.Balance.Limit.Income.Student_Yes.Cards.Limit2, sigma_2.Balance.Limit.Income.Student_Yes.Cards.Limit2, sigma_3.Balance.Limit.Income.Student_Yes.Cards.Limit2,  sigma_4.Balance.Limit.Income.Student_Yes.Cards.Limit2, sigma_5.Balance.Limit.Income.Student_Yes.Cards.Limit2, sigma_6.Balance.Limit.Income.Student_Yes.Cards.Limit2,  0, t_0.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_1.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_2.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_3.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_4.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_5.Balance.Limit.Income.Student_Yes.Cards.Limit2, t_6.Balance.Limit.Income.Student_Yes.Cards.Limit2, f[1], pvalue_0.Balance.Limit.Income.Student_Yes.Cards.Limit2, pvalue_1.Balance.Limit.Income.Student_Yes.Cards.Limit2, pvalue_2.Balance.Limit.Income.Student_Yes.Cards.Limit2,pvalue_3.Balance.Limit.Income.Student_Yes.Cards.Limit2, pvalue_4.Balance.Limit.Income.Student_Yes.Cards.Limit2,pvalue_5.Balance.Limit.Income.Student_Yes.Cards.Limit2, pvalue_6.Balance.Limit.Income.Student_Yes.Cards.Limit2, p.Value.f),digits = 5, format = "f"), ncol=4)

#specify row and column names of matrix
rownames(data.Balance.Limit.Income.Student_Yes.Cards.Limit2) <- c('β_0', 'β_1','β_2', 'β_3', 'β_4','β_5','β_6', 'F-Test (H0 : β1 = β2 = β3 = β4 = β5 = 0)')

colnames(data.Balance.Limit.Income.Student_Yes.Cards.Limit2) <- c('Coefficient', 'Std. error', 't-statistic', 'p-value')

#convert matrix to table
data.Balance.Limit.Income.Student_Yes.Cards.Limit2  <- as.table(data.Balance.Limit.Income.Student_Yes.Cards.Limit2)

#display table

data.Balance.Limit.Income.Student_Yes.Cards.Limit2

#Analisi dei residui

res <- resid(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)

print("The Root Mean Squared Error of the lm of Balance onto Limit, Income, Student (0/1) and Cards in the Credit Data Set is:")
RMSE <- sqrt(mean(res^2))
RMSE

Criterions <- glance(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)
Criterions

#produce residual vs. fitted plot
plot(fitted(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2), res)

#add a horizontal line at 0 
abline(0,0)

#create Q-Q plot for residuals
qqnorm(res)

#add a straight diagonal line to the plot
qqline(res) 

#Create density plot of residuals
plot(density(res))

```

7.1 Forward Stepwise selection:


Provando ad avere un approccio più analitico alla selezione del modello proviamo ad implementare una selezione Forward stepwise.

Per semplicità considereremo come regressori solamente le 11 variabili del dataset (no grado > 1, no variabili di interazione, no Rating perché collineare)

Metodo Forward Stepwise:

1. Sia M0 il modello con solamente l'intercetta (null model)
2. per j = 0,...,k−1:
Ad ogni passo onsideriamo tutti i k-j modelli che è possibile ottenere aggiungendo un ulteriore variabile al modello M_j;
Il criterio sarà selezionare il modello aumentato di una variabile Mj+1 con devianza minore, chiamandolo Mj+1
3. Si seleziona il migliore modello tra M0, . . . , Mk usando in questo caso AIC.

Rispetto al precedente modello scelto euristicamente, il metodo forward stepwise ci suggerisce di aggiungere anche la variabile Age (prima avevamo inserito solamente Limit, Income, Student, Cards).
Le differenze sia nelle stime dei coefficienti del modello che nelle stime indirette del test error (AIC, BIC,..) sono molto esigue rispetto al modello precedente.
In più notiamo come questo sia l'unico coefficiente ad avere una significatività con p-value > 0.01

Proviamo nel prossimo paragrafo ad anaalizzare altri criteri di selezione con il metodo best subset selectio, plottando i valori di BIC, Cp e adj R2, per vedere se risulta fondamentale aggiungere delle variabili oltre le 4 scelte euristicamente.

```{r}
#define intercept-only model
dataDummies3 <- dataDummies2

#dataDummies3 <- dataDummies3  %>% mutate (Limit4 = poly(Limit, 4))

dataDummies3$Rating <- NULL

intercept_only <- lm(Balance ~ 1, data = dataDummies3)

#define model with all predictors
all <- lm(Balance  ~ ., data=dataDummies3)

#perform forward stepwise regression
forward <- step(intercept_only, direction='forward', scope = formula(all))

#view results of forward stepwise regression
forward$anova


#view final model
forward$coefficients

Optimal.model <- lm(Balance  ~  Limit + Income + Student_Yes + Cards + Age, data=dataDummies2)
summary(Optimal.model)

#Analisi dei residui

res <- resid(dataDummies2.Balance.lm.Limit.Income.Student_Yes.Cards.Limit2)

print("The Root Mean Squared Error of the lm of Balance onto poly(Limit, 4), Income, Student (0/1) and Cards in the Credit Data Set is:")
RMSE <- sqrt(mean(res^2))
RMSE

Criterions <- glance(Optimal.model)
Criterions

#produce residual vs. fitted plot
plot(fitted(Optimal.model), res)

#add a horizontal line at 0 
abline(0,0)

#create Q-Q plot for residuals
qqnorm(res)

#add a straight diagonal line to the plot
qqline(res) 

#Create density plot of residuals
plot(density(res))


```
7.2 Best Subset Selection

La funzione regsubsets() (parte della libreria leaps) esegue la selezione del miglior sottoinsieme identificando il miglior modello che contiene un dato numero di predittori, dove il migliore è quantificato usando RSS. La sintassi è la stessa di lm(). Il comando summary() fornisce il miglior insieme di variabili per ogni dimensione del modello.

Un asterisco ("*") indica che una determinata variabile è inclusa nel modello corrispondente.
Combinando la tabella printata e il grafico che fa la selezione a seconda di diversi criteri (adjR2, BIC, CP in particolare), possiamo vedere quale è il modello selezionato in questo caso.

- Il criterio Adj R2 ci suggerisce il modello a 6 variabili seguente:
Limit, Income, Student, Cards, Age, Own_Yes

- Il criterio Cp, ci consiglia un modello a 5 variabili, che contiene le stesse variabili indicate precedentemente dal metodo forward stepwise con criterio AIC: Limit, Income, Student, Cards, Age.

Il criterio BIC ci suggerisce il modello più semplice a 4 variabili scelto euristicamente precedentemente:
Limit, Income, Student, Cards
 
Date le diverse stime indirette ottenute con i vari criteri, la scelta dovrebbe ricadere intorno al modello con 4 o 5 variabili, già analizzati precedentemente.

Notiamo comunque che dopo l'aggiunta della quarta variabile, tutti i grafici tendono a diventare molto piatti, indicando che aggiungere predittori al modello dopo i primi 4 ( Limit, Income, Student e Cards) non risulta avere un grande impatto sull'errore stimato.

```{r}

Complete.model = regsubsets(Balance~., data = dataDummies3, nvmax = 12)
Complete.model_summary = summary(Complete.model)
Complete.model_summary


# Set up a 2x2 grid so we can look at 4 plots at once
par(mfrow = c(2,2))
plot(Complete.model_summary$rss, xlab = "Number of Variables", ylab = "RSS", type = "l")

plot(Complete.model_summary$adjr2, xlab = "Number of Variables", ylab = "Adjusted RSq", type = "b")
adj_r2_max = which.max(Complete.model_summary$adjr2) 
points(adj_r2_max, Complete.model_summary$adjr2[adj_r2_max], col ="red", cex = 2, pch = 20)

plot(Complete.model_summary$cp, xlab = "Number of Variables", ylab = "Cp", type = "b")
cp_min = which.min(Complete.model_summary$cp) # 10
points(cp_min, Complete.model_summary$cp[cp_min], col = "red", cex = 2, pch = 20)

plot(Complete.model_summary$bic, xlab = "Number of Variables", ylab = "BIC", type = "b")
bic_min = which.min(Complete.model_summary$bic) # 6
points(bic_min, Complete.model_summary$bic[bic_min], col = "red", cex = 2, pch = 20)

coef(Complete.model, 4)

```

